<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Hardin â€“ Åehir AnÄ± AlbÃ¼mÃ¼n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg: #f6f4f1;
      --card-bg: #ffffff;
      --text: #2d3029;
      --accent: #745e4d;
      --accent-soft: #e3dfd8;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      line-height: 1.5;
    }

    /* iOS zoom'u engellemek iÃ§in input/textarea font 16px */
    input, textarea {
      font-family: inherit;
      font-size: 16px;
    }
    /* Ã–zellikle not ve ekstra alanlarÄ± iÃ§in garanti */
    .note-input,
    .note-textarea,
    .extra-input,
    .extra-textarea {
      font-size: 16px;
    }

    .topbar {
      width: 100%;
      padding: 10px 16px;
      background: #2d3029;
      color: #f6f4f1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .topbar-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.95rem;
    }

    .page {
      max-width: 960px;
      margin: 18px auto 32px;
      padding: 0 14px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 22px 18px 24px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
    }

    .card-with-bg {
      position: relative;
      overflow: hidden;
    }
    .card-with-bg .card-bg {
      position: absolute;
      inset: 0;
      background-image: url("https://raw.githubusercontent.com/hardinstore/Hardin/main/deneme/deneme.jpeg");
      background-size: cover;
      background-position: center;
      opacity: 0.3;
      filter: blur(2px);
      transform: scale(1.05);
    }
    .card-inner {
      position: relative;
      backdrop-filter: blur(1px);
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.6rem;
    }
    .subtitle {
      font-size: 0.95rem;
      margin: 0 0 10px;
      line-height: 1.45;
    }
    .note {
      font-size: 0.8rem;
      color: #7a7a7a;
      margin-bottom: 14px;
    }

    .btn-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    .btn {
      border-radius: 999px;
      padding: 11px 18px;
      font-size: 0.95rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
      border: none;
      text-decoration: none;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    }
    .btn-secondary {
      background: var(--accent-soft);
      color: var(--text);
    }
    .btn-ghost {
      background: transparent;
      color: var(--text);
      padding-left: 0;
      padding-right: 0;
      box-shadow: none;
      font-size: 0.9rem;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.16);
    }
    .btn-emoji { font-size: 1rem; }

    .city-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 11px;
      border-radius: 999px;
      background: rgba(255,255,255,0.8);
      font-size: 0.8rem;
      margin-bottom: 10px;
    }
    .city-tag span { opacity: 0.9; }

    .travel-badge {
      margin-left: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(116,94,77,0.12);
      font-size: 0.78rem;
      color: #5a4a3d;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .home-counter {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #444;
    }

    .home-storage-note {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #666;
      line-height: 1.35;
    }

    .home-thumbs {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
    }
    .home-thumb {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      background: #ddd;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .home-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      cursor: pointer;
    }

    .home-bottom-buttons {
      margin-top: 14px;
    }

    .home-travel-score {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #444;
      cursor: pointer;
    }

    .social-row {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .social-btn {
      font-size: 0.85rem;
      padding: 7px 11px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      text-decoration: none;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    }

    .info-links {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.85rem;
    }
    .info-link {
      color: #555;
      text-decoration: underline;
      cursor: pointer;
    }

    .counter {
      font-size: 0.85rem;
      color: #777;
      margin-top: 8px;
    }

    #fileInput { display: none; }

    /* AlbÃ¼m yÃ¶net grid */
    #photos {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 18px;
    }
    .photo-card {
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .photo {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: #d9d9d9;
      aspect-ratio: 3 / 4;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .delete {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0,0,0,0.6);
      width: 26px;
      height: 26px;
      border-radius: 999px;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      backdrop-filter: blur(3px);
    }
    .note-input {
      font-size: 16px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      outline: none;
      background: #f7f4f0;
      color: #444;
      width: 100%;
    }
    .note-input::placeholder { color: #aaa; }

    .empty {
      margin-top: 12px;
      color: #777;
      font-size: 0.9rem;
    }

    .view { display: none; }
    .view.active { display: block; }

    /* SLAYT OVERLAY */
    .slideshow-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      color: #fff;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
      overflow: hidden;
    }
    .slideshow-overlay.active { display: flex; }

    .slide-top {
      position: absolute;
      top: 10px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 14px;
      font-size: 0.95rem;
      z-index: 2;
    }
    .slide-top-center {
      flex: 1;
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.9;
    }
    .slide-btn {
      background: rgba(0,0,0,0.5);
      border-radius: 999px;
      padding: 6px 10px;
      border: none;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .slide-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      border: none;
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
    }
    .slide-nav.prev { left: 10px; }
    .slide-nav.next { right: 10px; }
    .slide-counter {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    .slide-img-wrap {
      max-width: 100%;
      max-height: calc(100vh - 140px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .slide-img-wrap img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .slide-note {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      padding: 6px 12px;
      border-radius: 999px;
      max-width: 90%;
      font-size: 0.85rem;
      text-align: center;
      opacity: 0.95;
      color: #fff;
      word-wrap: break-word;
    }
    .slide-note:empty { display: none; }

    .slide-album-date { white-space: nowrap; }

    /* MODALLAR */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    .modal-overlay.active { display: flex; }
    .modal-card {
      background: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      max-width: 420px;
      width: calc(100% - 40px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      font-size: 0.9rem;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .modal-title {
      font-weight: 600;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
    }
    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .pill-btn {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .pill-primary {
      background: var(--accent);
      color: #fff;
    }
    .pill-secondary {
      background: var(--accent-soft);
      color: var(--text);
    }

    .faq-q {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      cursor: pointer;
    }
    .faq-a {
      display: none;
      padding: 4px 0 8px;
      font-size: 0.85rem;
      color: #555;
    }
    .faq-item.open .faq-a { display: block; }
    .faq-item.open .faq-q span:last-child { transform: rotate(45deg); }

    /* Koleksiyon sayfasÄ± grid */
    .collection-grid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .collection-card {
      border-radius: 12px;
      padding: 10px;
      background: #f8f4ef;
      box-shadow: 0 3px 8px rgba(0,0,0,0.06);
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .collection-card.locked {
      opacity: 0.45;
      cursor: default;
    }
    .collection-card.current {
      border: 1px solid var(--accent);
      background: #f1e9e1;
    }
    .collection-title {
      font-weight: 600;
    }
    .collection-status {
      font-size: 0.8rem;
      color: #555;
    }

    @media (min-width: 768px) {
      .card { padding: 24px 22px 26px; }
      h1 { font-size: 1.8rem; }
      #photos { grid-template-columns: repeat(3, minmax(0,1fr)); }
      .collection-grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    /* Eski gezi skoru yazÄ±sÄ±nÄ± tamamen gizle */
    #travelScoreHome {
      display: none;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-title">HARDÄ°N â€¢ AKILLI ANI MAGNETÄ° (V57)</div>
  </div>

  <div class="page">
    <!-- ANA SAYFA -->
    <section id="view-home" class="view active">
      <div class="card card-with-bg">
        <div class="card-bg"></div>
        <div class="card-inner">
          <div class="city-tag">
            <strong>AlbÃ¼m:</strong> <span id="albumLabel">Deneme</span>
            <span id="travelScoreBadge" class="travel-badge"></span>
          </div>

          <h1>Åehir AnÄ± AlbÃ¼mÃ¼n</h1>
          <p class="subtitle">
            Bu magneti okuttuÄŸunda, bu sayfa senin o ÅŸehre ait
            <strong>kiÅŸisel anÄ± albÃ¼mÃ¼n</strong> olur. FotoÄŸraflar sadece burada,
            bu cihazda kalÄ±r.
          </p>
          <p class="note">
            AÅŸaÄŸÄ±dan albÃ¼mÃ¼nÃ¼ oluÅŸturabilir, yeni fotoÄŸraf ekleyebilir veya
            anÄ±larÄ±nÄ± tam ekran slayt gÃ¶sterisiyle izleyebilirsin.
          </p>

          <div class="btn-row">
            <button class="btn btn-primary" type="button" onclick="setView('manage')">
              <span class="btn-emoji">ğŸ“·</span>
              <span>AlbÃ¼m Ekle</span>
            </button>

            <button id="playButton" class="btn btn-secondary" type="button" onclick="openSlideshow(0)">
              ğŸï¸ AnÄ±larÄ± CanlandÄ±r
            </button>
          </div>

          <div id="homeCounter" class="home-counter"></div>
          <div class="home-storage-note">
            Not: Bu albÃ¼m yalnÄ±zca <strong>bu cihazdaki bu tarayÄ±cÄ±da</strong> saklanÄ±r.
            TarayÄ±cÄ± veya cihaz deÄŸiÅŸtirirsen albÃ¼mÃ¼nÃ¼ yeniden oluÅŸturman gerekir.
          </div>

          <div id="homeThumbs" class="home-thumbs"></div>

          <!-- Alt butonlar: Magnetler + gezi durumum -->
          <div class="btn-row home-bottom-buttons">
            <button class="btn btn-secondary" type="button" onclick="setView('collection')">
              ğŸ—ƒï¸ Magnetlerim
            </button>
            <button class="btn btn-secondary" type="button" onclick="openProgressModal()">
              ğŸ“ Gezi durumum
            </button>
          </div>

          <div id="travelScoreHome" class="home-travel-score" onclick="openProgressModal()"></div>

          <!-- Sosyal ikonlar (linkleri kendi adreslerinle deÄŸiÅŸtir) -->
          <div class="social-row">
            <a class="social-btn" href="https://www.instagram.com/hardinstore?igsh=ZnM1M3hsa3lzcmY0&utm_source=qr" target="_blank" rel="noopener noreferrer">
              ğŸ“· <span>Instagram</span>
            </a>
            <a class="social-btn" href="https://wa.me/905387899777" target="_blank" rel="noopener noreferrer">
              ğŸ’¬ <span>WhatsApp</span>
            </a>
            <a class="social-btn" href="https://www.trendyol.com/magaza/m-m-975865" target="_blank" rel="noopener noreferrer">
              ğŸ›ï¸ <span>MaÄŸaza</span>
            </a>
          </div>

          <!-- HakkÄ±nda / SSS / Åikayet -->
          <div class="info-links">
            <span class="info-link" onclick="openInfoModal('about')">HakkÄ±nda</span>
            <span class="info-link" onclick="openInfoModal('faq')">SÄ±k Sorulan Sorular</span>
            <span class="info-link" onclick="openInfoModal('complaint')">Åikayet &amp; Talep</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ALBÃœMÃœ YÃ–NET -->
    <section id="view-manage" class="view">
      <div class="card">
        <button class="btn btn-ghost" type="button" onclick="setView('home')">
          â† Ana sayfaya dÃ¶n
        </button>

        <h1>AlbÃ¼mÃ¼ YÃ¶net</h1>
        <p class="subtitle">
          FotoÄŸraf ekleyebilir, not yazabilir, tarihi belirleyebilir ve albÃ¼mÃ¼nÃ¼
          dilediÄŸin zaman gÃ¼ncelleyebilirsin.
        </p>

        <div class="btn-row">
          <label class="btn btn-primary" for="fileInput">
            <span class="btn-emoji">ğŸ“¸</span>
            <span>FotoÄŸraf Ekle</span>
          </label>

          <button class="btn btn-secondary" type="button" onclick="clearAllPhotos()">
            ğŸ§¹ AlbÃ¼m Temizle
          </button>

          <button class="btn btn-secondary" type="button" onclick="showDateModal()">
            ğŸ“… Tarih Belirle
          </button>

          <button class="btn btn-secondary" type="button" onclick="showMusicModal()">
            ğŸµ Fon MÃ¼ziÄŸi SeÃ§
          </button>
        </div>

        <div id="counter" class="counter"></div>
        <div id="musicInfo" class="counter"></div>

        <input id="fileInput" type="file" accept="image/*" multiple>

        <div id="photos"></div>
        <div id="emptyMsg" class="empty"></div>
      </div>
    </section>

    <!-- KOLEKSÄ°YON / DÄ°ÄER MAGNETLER -->
    <section id="view-collection" class="view">
      <div class="card">
        <button class="btn btn-ghost" type="button" onclick="setView('home')">
          â† Ana sayfaya dÃ¶n
        </button>

        <h1>Magnetlerim</h1>
        <p class="subtitle">
          Bu cihazda oluÅŸturduÄŸun diÄŸer ÅŸehir albÃ¼mlerini aÅŸaÄŸÄ±dan gÃ¶rebilirsin.
          AlbÃ¼mÃ¼ olan magnetlerin Ã¼zerine dokunarak ilgili sayfaya gidebilirsin.
        </p>

        <div id="collectionGrid" class="collection-grid"></div>
      </div>
    </section>
  </div>

  <!-- SLAYT OVERLAY -->
  <div id="slideshow" class="slideshow-overlay">
    <div class="slide-top">
      <button class="slide-btn" type="button" onclick="closeSlideshow()">âœ• Kapat</button>

      <div class="slide-top-center">
        <span id="slideAlbumDate" class="slide-album-date"></span>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="playPauseBtn" class="slide-btn" type="button" onclick="togglePlay()">
          â–¶ï¸ Oynat
        </button>
        <div class="slide-counter" id="slideCounter"></div>
      </div>
    </div>

    <button class="slide-nav prev" type="button" onclick="prevSlide()">â®</button>
    <div class="slide-img-wrap">
      <img id="slideImage" src="" alt="AnÄ± fotoÄŸrafÄ±">
    </div>
    <button class="slide-nav next" type="button" onclick="nextSlide()">â¯</button>

    <div id="slideNote" class="slide-note"></div>
  </div>

  <!-- INFO MODAL -->
  <div id="infoModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div id="infoModalTitle" class="modal-title"></div>
        <button class="modal-close" type="button" onclick="closeInfoModal()">Ã—</button>
      </div>
      <div id="infoModalBody" class="modal-body"></div>
    </div>
  </div>

  <!-- TARÄ°H MODALI -->
  <div id="dateModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">AlbÃ¼m Tarihi</div>
        <button class="modal-close" type="button" onclick="closeDateModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <button class="pill-btn pill-secondary" type="button" onclick="setDatePreset('today')">BugÃ¼n</button>
          <button class="pill-btn pill-secondary" type="button" onclick="setDatePreset('yesterday')">DÃ¼n</button>
        </div>
        <div>
          <label style="font-size:0.85rem; color:#555;">Ã–zel tarih (GG.AA.YYYY):</label>
          <input id="dateInput" type="text" style="width:100%; margin-top:4px; padding:5px 8px; border-radius:8px; border:1px solid rgba(0,0,0,0.15); font-size:16px;" placeholder="Ã–rn: 07.12.2025">
        </div>
      </div>
      <div class="modal-footer">
        <button class="pill-btn pill-secondary" type="button" onclick="closeDateModal()">Ä°ptal</button>
        <button class="pill-btn pill-primary" type="button" onclick="saveDate()">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- MÃœZÄ°K MODALI -->
  <div id="musicModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Fon MÃ¼ziÄŸi SeÃ§</div>
        <button class="modal-close" type="button" onclick="closeMusicModal(true)">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="musicList"></div>
      </div>
      <div class="modal-footer">
        <button class="pill-btn pill-secondary" type="button" onclick="closeMusicModal(true)">Ä°ptal</button>
        <button class="pill-btn pill-primary" type="button" onclick="saveMusic()">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- GEZÄ° DURUMU MODALI -->
  <div id="progressModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Gezi Durumum</div>
        <button class="modal-close" type="button" onclick="closeProgressModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="font-size:0.85rem; color:#555;">
          Bu ÅŸehirde yapmayÄ± planladÄ±ÄŸÄ±n yerleri ve lezzetleri iÅŸaretle. AÅŸaÄŸÄ±daki
          yÃ¼zde, planÄ±na gÃ¶re ne kadarÄ±nÄ± tamamladÄ±ÄŸÄ±nÄ± gÃ¶sterir.
        </p>

        <div style="margin-top:6px; font-weight:600; font-size:0.9rem;">GÃ¶rÃ¼lmesi gereken yerler</div>
        <div id="progressPlaces"></div>

        <div style="margin-top:10px; font-weight:600; font-size:0.9rem;">Yenilmesi gereken lezzetler</div>
        <div id="progressFoods"></div>

        <div style="margin-top:10px; font-weight:600; font-size:0.9rem;">
          Åehre ait bir Ã¼rÃ¼n aldÄ±n mÄ±? <span style="font-weight:400; font-size:0.85rem;">(Hardin magnet hariÃ§)</span>
        </div>
        <div id="progressPurchase"></div>

        <div style="margin-top:10px; font-weight:600; font-size:0.9rem;">Ekstralar</div>
        <div id="progressExtras"></div>

        <div id="progressResult" style="margin-top:8px; font-size:0.88rem; color:#333;"></div>
      </div>
      <div class="modal-footer">
        <button class="pill-btn pill-secondary" type="button" onclick="closeProgressModal()">Kapat</button>
        <button class="pill-btn pill-primary" type="button" onclick="calculateProgress()">Hesapla</button>
      </div>
    </div>
  </div>

  <audio id="bgAudio" loop></audio>
  <audio id="previewAudio"></audio>

  <script>
    // AlbÃ¼m kimlikleri
    const params = new URLSearchParams(window.location.search);
    const CURRENT_ID = params.get("album") || "deneme";

    const ALBUM_IDS = ["deneme", "deneme1", "deneme2", "deneme3", "deneme4", "deneme5", "deneme6"];
    const ALBUM_LABELS = {
      deneme:  "Deneme",
      deneme1: "Deneme 1",
      deneme2: "Deneme 2",
      deneme3: "Deneme 3",
      deneme4: "Deneme 4",
      deneme5: "Deneme 5",
      deneme6: "Deneme 6"
    };

    const ALBUM_KEY = "hardin_album_" + CURRENT_ID;
    const META_KEY  = ALBUM_KEY + "_meta";
    const MAX_PHOTOS = 20;

    const MUSIC_OPTIONS = {
      none:   { id:"none",   label:"SeÃ§ilmemiÅŸ", src:null },
      track1: { id:"track1", label:"Piyano", src:"music1.mp3" },
      track2: { id:"track2", label:"Lo-fi",  src:"music2.mp3" }
    };

    // Gezi durumu iÃ§in anahtar
    const PROGRESS_KEY = "hardin_progress_" + CURRENT_ID;
    const PROGRESS_TEMPLATE = {
      places: { p1:false, p2:false, p3:false },
      foods:  { f1:false, f2:false, f3:false },
      purchase: false,
      extras: ["", "", ""],
      score: null
    };
    const PROGRESS_LABELS = {
      places: {
        p1: "Åehrin ana meydanÄ±nÄ± gÃ¶rdÃ¼m",
        p2: "Sahilde / manzaralÄ± bir noktada zaman geÃ§irdim",
        p3: "Tarihi veya turistik bir yeri ziyaret ettim"
      },
      foods: {
        f1: "Bu ÅŸehre Ã¶zgÃ¼ bir ana yemek denedim",
        f2: "Yerel bir tatlÄ± tattÄ±m",
        f3: "Yerel bir iÃ§ecek veya kahve iÃ§tim"
      }
    };

    let photos = [];
    let albumMeta = { date: null, music: "none" };
    let currentSlide = 0;
    let slideTimer = null;
    let isPlaying = false;

    let touchStartX = 0;
    let touchEndX = 0;

    let tempMusicChoice = albumMeta.music;

    // Gezi durumu verisi
    let progress = JSON.parse(JSON.stringify(PROGRESS_TEMPLATE));

    // AlbÃ¼mÃ¼ yÃ¼kle (eski format desteÄŸi)
    try {
      const stored = JSON.parse(localStorage.getItem(ALBUM_KEY) || "[]");
      if (Array.isArray(stored)) {
        if (stored.length && typeof stored[0] === "string") {
          photos = stored.map(src => ({ src, note: "" }));
          localStorage.setItem(ALBUM_KEY, JSON.stringify(photos));
        } else {
          photos = stored;
        }
      }
    } catch (e) { photos = []; }

    try {
      const m = JSON.parse(localStorage.getItem(META_KEY) || "null");
      if (m && typeof m === "object") albumMeta = { ...albumMeta, ...m };
      tempMusicChoice = albumMeta.music;
    } catch (e) {}

    try {
      const p = JSON.parse(localStorage.getItem(PROGRESS_KEY) || "null");
      if (p && typeof p === "object") {
        progress = {
          ...PROGRESS_TEMPLATE,
          ...p,
          places: { ...PROGRESS_TEMPLATE.places, ...(p.places || {}) },
          foods:  { ...PROGRESS_TEMPLATE.foods,  ...(p.foods || {})  }
        };
        if (!Array.isArray(progress.extras)) {
          if (typeof p.extra === "string" && p.extra.trim()) {
            progress.extras = [p.extra, "", ""];
          } else {
            progress.extras = ["", "", ""];
          }
        }
      }
    } catch (e) {}

    if (!Array.isArray(progress.extras)) {
      progress.extras = ["", "", ""];
    } else {
      while (progress.extras.length < 3) progress.extras.push("");
      if (progress.extras.length > 3) progress.extras = progress.extras.slice(0,3);
    }

    // AlbÃ¼m etiketi
    const labelEl = document.getElementById("albumLabel");
    if (labelEl) {
      labelEl.innerText = ALBUM_LABELS[CURRENT_ID] || CURRENT_ID;
    }

    function setView(view) {
      document.querySelectorAll(".view").forEach(el => el.classList.remove("active"));
      const el = document.getElementById("view-" + view);
      if (el) el.classList.add("active");
    }

    function getPhotosForAlbum(id) {
      try {
        const raw = JSON.parse(localStorage.getItem("hardin_album_" + id) || "[]");
        return Array.isArray(raw) ? raw : [];
      } catch (e) {
        return [];
      }
    }
    function getPhotoCountForAlbum(id) {
      return getPhotosForAlbum(id).length;
    }
    function hasPhotosFor(id) {
      return getPhotoCountForAlbum(id) > 0;
    }

    // Koleksiyon grid
    function renderCollectionGrid() {
      const grid = document.getElementById("collectionGrid");
      if (!grid) return;
      grid.innerHTML = "";
      ALBUM_IDS.forEach(id => {
        const count = getPhotoCountForAlbum(id);
        const has = count > 0;
        const card = document.createElement("div");
        card.className = "collection-card";
        if (!has) card.classList.add("locked");
        if (id === CURRENT_ID) card.classList.add("current");

        const title = document.createElement("div");
        title.className = "collection-title";
        title.textContent = ALBUM_LABELS[id] || id;

        const status = document.createElement("div");
        status.className = "collection-status";
        if (has) {
          status.textContent = count + " fotoÄŸraf iÃ§eren albÃ¼m";
        } else {
          status.textContent = "Bu cihazda henÃ¼z albÃ¼m yok";
        }

        card.appendChild(title);
        card.appendChild(status);

        card.onclick = () => {
          if (!has) {
            alert("Bu magnet iÃ§in henÃ¼z bu cihazda albÃ¼m oluÅŸturulmadÄ±. Ã–nce o magneti okutup fotoÄŸraf ekle.");
            return;
          }
          if (id === CURRENT_ID) {
            setView("manage");
            return;
          }
          const url = new URL(window.location.href);
          url.searchParams.set("album", id);
          window.location.href = url.toString();
        };

        grid.appendChild(card);
      });
    }

    // Kaydet fonksiyonlarÄ±
    function savePhotos() {
      try {
        localStorage.setItem(ALBUM_KEY, JSON.stringify(photos));
        return true;
      } catch (e) {
        alert("AlbÃ¼m telefon hafÄ±zasÄ±nda izin verilen sÄ±nÄ±ra ulaÅŸtÄ±. Yeni fotoÄŸraf eklemek iÃ§in Ã¶nce bazÄ±larÄ±nÄ± silmen gerekiyor.");
        console.error(e);
        return false;
      }
    }
    function saveMeta() {
      try {
        localStorage.setItem(META_KEY, JSON.stringify(albumMeta));
      } catch (e) { console.error(e); }
    }
    function saveProgress() {
      try {
        localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
      } catch (e) { console.error(e); }
    }

    // SayaÃ§lar + tarih + mÃ¼zik info
    function updateCounters() {
      const manageCounter = document.getElementById("counter");
      const homeCounter   = document.getElementById("homeCounter");
      const playButton    = document.getElementById("playButton");
      const slideAlbumDate= document.getElementById("slideAlbumDate");
      const musicInfo     = document.getElementById("musicInfo");

      let textMain = "";
      if (photos.length === 1) textMain = "AlbÃ¼mÃ¼nde 1 fotoÄŸraf var";
      else if (photos.length > 1) textMain = "AlbÃ¼mÃ¼nde " + photos.length + " fotoÄŸraf var";
      else textMain = "HenÃ¼z fotoÄŸraf eklenmedi";

      let datePart = albumMeta.date ? (" â€¢ Tarih: " + albumMeta.date) : "";

      if (manageCounter) manageCounter.innerText = photos.length ? (textMain + datePart) : "";
      if (homeCounter) homeCounter.innerText = photos.length ? (textMain + datePart) : "HenÃ¼z fotoÄŸraf eklenmedi. BaÅŸlamak iÃ§in aÅŸaÄŸÄ±dan AlbÃ¼m Ekleâ€™ye dokun.";
      if (slideAlbumDate) slideAlbumDate.innerText = albumMeta.date ? albumMeta.date : "";

      if (playButton) {
        playButton.disabled = photos.length === 0;
        playButton.style.opacity = photos.length === 0 ? "0.4" : "1";
      }

      if (musicInfo) {
        const opt = MUSIC_OPTIONS[albumMeta.music] || MUSIC_OPTIONS.none;
        musicInfo.innerText = "Fon mÃ¼ziÄŸi: " + opt.label;
      }
    }

    // Ana ekrandaki kÃ¼Ã§Ã¼k fotoÄŸraflar
    function updateHomeThumbs() {
      const container = document.getElementById("homeThumbs");
      if (!container) return;
      container.innerHTML = "";
      if (!photos.length) return;

      const start = Math.max(photos.length - 4, 0);
      for (let i = start; i < photos.length; i++) {
        const div = document.createElement("div");
        div.className = "home-thumb";
        const img = document.createElement("img");
        img.src = photos[i].src;
        img.onclick = () => openSlideshow(i);
        div.appendChild(img);
        container.appendChild(div);
      }
    }

    function updateTravelScoreDisplay() {
      const badgeEl = document.getElementById("travelScoreBadge");
      const textEl  = document.getElementById("travelScoreHome");
      if (!badgeEl) return;

      if (progress.score == null) {
        badgeEl.innerText = "";
        if (textEl) textEl.innerText = "";
        return;
      }
      const cityName = ALBUM_LABELS[CURRENT_ID] || "Bu ÅŸehir";
      badgeEl.innerHTML = `â­ %${progress.score}`;
      if (textEl) {
        textEl.innerText = `${cityName} gezi skoru: %${progress.score} (detaylar iÃ§in dokun)`;
      }
    }

    // AlbÃ¼m render
    function render() {
      const container = document.getElementById("photos");
      const empty = document.getElementById("emptyMsg");
      if (!container || !empty) return;

      container.innerHTML = "";
      empty.innerText = photos.length ? "" : "HenÃ¼z fotoÄŸraf eklenmedi. BaÅŸlamak iÃ§in yukarÄ±daki butona dokun.";

      photos.forEach((photo, index) => {
        const card = document.createElement("div");
        card.className = "photo-card";

        const div = document.createElement("div");
        div.className = "photo";

        const img = document.createElement("img");
        img.src = photo.src;
        img.onclick = () => openSlideshow(index);

        const del = document.createElement("div");
        del.className = "delete";
        del.innerText = "Ã—";
        del.onclick = (e) => {
          e.stopPropagation();
          photos.splice(index, 1);
          savePhotos();
          render();
        };

        div.appendChild(img);
        div.appendChild(del);

        const noteInput = document.createElement("input");
        noteInput.className = "note-input";
        noteInput.type = "text";
        noteInput.placeholder = "Bu fotoÄŸraf iÃ§in kÃ¼Ã§Ã¼k bir not ekle...";
        noteInput.value = photo.note || "";
        noteInput.oninput = (e) => {
          photos[index].note = e.target.value || "";
          savePhotos();
          updateHomeThumbs();
          const overlay = document.getElementById("slideshow");
          if (overlay && overlay.classList.contains("active") && index === currentSlide) {
            updateSlideImage();
          }
        };

        card.appendChild(div);
        card.appendChild(noteInput);
        container.appendChild(card);
      });

      updateCounters();
      updateHomeThumbs();
      renderCollectionGrid();
      updateTravelScoreDisplay();
    }

    // FotoÄŸraf eklerken kÃ¼Ã§Ã¼lt
    function addFileCompressed(file) {
      if (photos.length >= MAX_PHOTOS) {
        alert("Bu albÃ¼m en fazla " + MAX_PHOTOS + " fotoÄŸraf saklayabilir. Yeni fotoÄŸraf eklemek iÃ§in Ã¶nce bazÄ±larÄ±nÄ± sil.");
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const maxSize = 800;
          let w = img.width, h = img.height;
          const scale = Math.min(maxSize / w, maxSize / h, 1);
          w = Math.round(w * scale);
          h = Math.round(h * scale);

          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);

          const dataUrl = canvas.toDataURL("image/jpeg", 0.6);
          photos.push({ src: dataUrl, note: "" });
          if (!savePhotos()) photos.pop();
          render();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    const fileInput = document.getElementById("fileInput");
    if (fileInput) {
      fileInput.addEventListener("change", function() {
        const files = Array.from(this.files);
        files.forEach(addFileCompressed);
        this.value = "";
      });
    }

    function clearAllPhotos() {
      if (!photos.length) return;
      if (!confirm("TÃ¼m fotoÄŸraflarÄ± silmek istediÄŸinden emin misin?")) return;
      photos = [];
      savePhotos();
      render();
    }

    // Tarih yardÄ±mcÄ±larÄ±
    function formatDate(d) {
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }
    function showDateModal() {
      document.getElementById("dateInput").value = albumMeta.date || "";
      document.getElementById("dateModal").classList.add("active");
    }
    function closeDateModal() {
      document.getElementById("dateModal").classList.remove("active");
    }
    function setDatePreset(type) {
      let d = new Date();
      if (type === "yesterday") d.setDate(d.getDate() - 1);
      document.getElementById("dateInput").value = formatDate(d);
    }
    function saveDate() {
      const val = document.getElementById("dateInput").value.trim();
      albumMeta.date = val || null;
      saveMeta();
      updateCounters();
      updateSlideImage();
      closeDateModal();
    }

    // MÃ¼zik modalÄ±
    function showMusicModal() {
      tempMusicChoice = albumMeta.music;
      const list = document.getElementById("musicList");
      list.innerHTML = "";
      ["track1","track2"].forEach(id => {
        const opt = MUSIC_OPTIONS[id];
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.justifyContent = "space-between";
        row.style.padding = "4px 0";

        const left = document.createElement("label");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "6px";
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "musicChoice";
        radio.value = id;
        radio.checked = (tempMusicChoice === id);
        radio.onchange = () => { tempMusicChoice = id; };
        left.appendChild(radio);
        const span = document.createElement("span");
        span.textContent = opt.label;
        left.appendChild(span);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "pill-btn pill-secondary";
        btn.textContent = "â–¶ï¸ Dinle";
        btn.onclick = () => previewTrack(id, btn);

        row.appendChild(left);
        row.appendChild(btn);
        list.appendChild(row);
      });
      document.getElementById("musicModal").classList.add("active");
    }
    function closeMusicModal(keepOld) {
      stopPreview();
      if (!keepOld) tempMusicChoice = albumMeta.music;
      document.getElementById("musicModal").classList.remove("active");
    }
    function previewTrack(id, btn) {
      const audio = document.getElementById("previewAudio");
      const opt = MUSIC_OPTIONS[id];
      if (!opt.src) return;
      if (!audio.paused && audio.dataset.current === id) {
        audio.pause();
        btn.textContent = "â–¶ï¸ Dinle";
        return;
      }
      audio.src = opt.src;
      audio.dataset.current = id;
      audio.play().catch(console.error);
      document.querySelectorAll("#musicList button").forEach(b => b.textContent = "â–¶ï¸ Dinle");
      btn.textContent = "â¸ Durdur";
    }
    function stopPreview() {
      const audio = document.getElementById("previewAudio");
      if (audio) audio.pause();
    }
    function saveMusic() {
      stopPreview();
      if (tempMusicChoice) albumMeta.music = tempMusicChoice;
      saveMeta();
      updateCounters();
      if (isPlaying) {
        applyAudioSettings();
        playAudioSafe();
      }
      closeMusicModal(false);
    }

    // Bilgi modalÄ±
    function openInfoModal(type) {
      const modal = document.getElementById("infoModal");
      const titleEl = document.getElementById("infoModalTitle");
      const bodyEl = document.getElementById("infoModalBody");

      if (type === "about") {
        titleEl.innerText = "HakkÄ±nda";
        bodyEl.innerHTML = `
         <p><strong>Hardin AkÄ±llÄ± AnÄ± Magneti</strong>, gezdiÄŸiniz ÅŸehirleri yalnÄ±zca bir buzdolabÄ± sÃ¼sÃ¼ olarak deÄŸil; iÃ§inde anÄ±larÄ±nÄ±zÄ± saklayan kÃ¼Ã§Ã¼k bir hatÄ±ra kutusu haline getirmek iÃ§in tasarlanmÄ±ÅŸtÄ±r.</p>

<p>Bu magneti okuttuÄŸunuzda aÃ§Ä±lan sayfa, gittiÄŸiniz ÅŸehre ait <strong>kiÅŸisel anÄ± albÃ¼mÃ¼nÃ¼zdÃ¼r</strong>. FotoÄŸraflarÄ±nÄ±zÄ± ekleyebilir, kÃ¼Ã§Ã¼k notlar bÄ±rakabilir, slayt gÃ¶sterisi ÅŸeklinde tekrar izleyebilir ve dilediÄŸinizde baÅŸkalarÄ±na gÃ¶sterebilirsiniz. BÃ¶ylece sÄ±radan bir magnet zaman iÃ§inde bir <strong>anÄ± defterine</strong> dÃ¶nÃ¼ÅŸÃ¼r.</p>

<p>Hardin magnetlerinin tÃ¼m tasarÄ±mlarÄ± Ã¶zenle hazÄ±rlanmÄ±ÅŸtÄ±r ve tasarÄ±m haklarÄ± <strong>Hardin</strong> markasÄ±na aittir.</p>

<p>Bu sistem tamamen <strong>kiÅŸisel gizlilik</strong> esas alÄ±narak geliÅŸtirilmiÅŸtir:</p>
<ul>
  <li>FotoÄŸraflarÄ±nÄ±z <strong>kesinlikle internete yÃ¼klenmez</strong>.</li>
  <li>Sunucuya veya baÅŸka bir yere aktarÄ±lmaz.</li>
  <li>YalnÄ±zca <strong>kendi telefonunuzdaki tarayÄ±cÄ± hafÄ±zasÄ±nda</strong> tutulur.</li>
  <li>FotoÄŸraflarÄ± sadece siz gÃ¶rebilir, sadece sizin cihazÄ±nÄ±zdan eriÅŸilebilir.</li>
</ul>

<p>TarayÄ±cÄ± veya cihaz deÄŸiÅŸtirirseniz albÃ¼mÃ¼nÃ¼zÃ¼ yeniden oluÅŸturmanÄ±z gerekir; Ã§Ã¼nkÃ¼ hiÃ§bir kÃ¶ÅŸede fotoÄŸraflarÄ±nÄ±z saklanmaz veya kaydedilmez.</p>

<p>Hardin AkÄ±llÄ± AnÄ± Magneti, gezi deneyiminizi daha anlamlÄ± kÄ±lmak ve kÃ¼Ã§Ã¼k bir magneti uzun yÄ±llar deÄŸer taÅŸÄ±yan bir hatÄ±raya dÃ¶nÃ¼ÅŸtÃ¼rmek amacÄ±yla geliÅŸtirilmiÅŸtir.</p>

<p>Her tÃ¼rlÃ¼ gÃ¶rÃ¼ÅŸ, talep veya tasarÄ±m iÅŸbirliÄŸi iÃ§in:<br>

 <strong>0 536 396 11 44</strong><br>
 <strong>Ã–kkeÅŸ Can DinÃ§er</strong></p>

        `;
      } else if (type === "faq") {
        titleEl.innerText = "SÄ±k Sorulan Sorular";
        bodyEl.innerHTML = `
          <div class="faq-item">
            <div class="faq-q"><span>FotoÄŸraflarÄ±m internete yÃ¼kleniyor mu?</span><span>+</span></div>
            <div class="faq-a">HayÄ±r. TÃ¼m fotoÄŸraflar, sadece bu cihazÄ±n tarayÄ±cÄ± hafÄ±zasÄ±nda saklanÄ±r.</div>
          </div>
          <div class="faq-item">
            <div class="faq-q"><span>TarayÄ±cÄ± deÄŸiÅŸtirince albÃ¼mÃ¼m neden boÅŸ?</span><span>+</span></div>
            <div class="faq-a">Her tarayÄ±cÄ± kendi iÃ§inde ayrÄ± hafÄ±za kullanÄ±r. AlbÃ¼m, bu sayfayÄ± ilk kullandÄ±ÄŸÄ±n tarayÄ±cÄ±ya kaydedilir. FarklÄ± bir tarayÄ±cÄ± veya cihazda albÃ¼mÃ¼nÃ¼ yeniden oluÅŸturman gerekir.</div>
          </div>
          <div class="faq-item">
            <div class="faq-q"><span>FotoÄŸraf sayÄ±sÄ±nÄ±n bir sÄ±nÄ±rÄ± var mÄ±?</span><span>+</span></div>
            <div class="faq-a">Telefonunun tarayÄ±cÄ± hafÄ±zasÄ±na baÄŸlÄ± olarak pratikte bir sÄ±nÄ±r vardÄ±r. SÄ±nÄ±r dolduÄŸunda uygulama seni uyarÄ±r ve yeni fotoÄŸraf iÃ§in bazÄ±larÄ±nÄ± silmeni ister.</div>
          </div>
         <div class="faq-item">
  <div class="faq-q">
    <span>NFC Ã¶zelliÄŸini baÅŸka telefonda kullandÄ±ÄŸÄ±mda neden albÃ¼m boÅŸ?</span>
    <span>+</span>
  </div>
  <div class="faq-a">
    Her telefon ve tarayÄ±cÄ± kendi iÃ§inde ayrÄ± bir hafÄ±za (localStorage) kullanÄ±r.
    Hardin magnetinin albÃ¼mÃ¼ tamamen bu hafÄ±zaya kaydedildiÄŸi iÃ§in baÅŸka bir telefonda
    veya baÅŸka bir tarayÄ±cÄ±da aÃ§tÄ±ÄŸÄ±nÄ±zda albÃ¼m yeniden boÅŸ gÃ¶rÃ¼nÃ¼r.
    FotoÄŸraflar internete yÃ¼klenmediÄŸi iÃ§in cihazlar arasÄ±nda otomatik aktarÄ±m yapÄ±lmaz.
  </div>
        `;
      } else if (type === "complaint") {
        titleEl.innerText = "Åikayet & Talep";
        bodyEl.innerHTML = `
          <p style="margin-top:0;">
            GÃ¶rÃ¼ÅŸ, ÅŸikayet veya Ã¶nerini aÅŸaÄŸÄ±ya yazÄ±p â€œMail GÃ¶nderâ€e tÄ±klayarak
            bize e-posta gÃ¶nderebilirsin.
          </p>
          <textarea id="complaintText" rows="4" style="width:100%; font-size:16px; padding:6px; border-radius:8px; border:1px solid rgba(0,0,0,0.15);"></textarea>
          <div style="text-align:right; margin-top:6px;">
            <button class="pill-btn pill-primary" type="button" onclick="sendComplaint()">âœ‰ï¸ Mail GÃ¶nder</button>
          </div>
        `;
      }

      // FAQ aÃ§/kapa
      bodyEl.onclick = (e) => {
        const q = e.target.closest(".faq-q");
        if (!q) return;
        const item = q.parentElement;
        item.classList.toggle("open");
      };

      modal.classList.add("active");
    }
    function closeInfoModal() {
      document.getElementById("infoModal").classList.remove("active");
    }
    function sendComplaint() {
      const txtEl = document.getElementById("complaintText");
      if (!txtEl) return;
      const text = txtEl.value.trim();
      if (!text) {
        alert("LÃ¼tfen mesajÄ±nÄ± yaz.");
        return;
      }
      const subject = encodeURIComponent("Hardin Åikayet / Talep");
      const body = encodeURIComponent(text);
      const mailto = "mailto:okkescandincer@gmail.com?subject=" + subject + "&body=" + body;
      window.location.href = mailto;
    }

    // Slayt
    function openSlideshow(startIndex) {
      if (!photos.length) {
        alert("HenÃ¼z fotoÄŸraf eklenmedi. Ã–nce albÃ¼me birkaÃ§ fotoÄŸraf ekle.");
        return;
      }
      currentSlide = (startIndex >= 0 && startIndex < photos.length) ? startIndex : 0;
      document.getElementById("slideshow").classList.add("active");
      stopAutoPlay();
      updateSlideImage();
      updatePlayButton();
    }
    function closeSlideshow() {
      document.getElementById("slideshow").classList.remove("active");
      stopAutoPlay();
    }
    function updateSlideImage() {
      const img = document.getElementById("slideImage");
      const counter = document.getElementById("slideCounter");
      const noteEl = document.getElementById("slideNote");
      const dateEl = document.getElementById("slideAlbumDate");
      if (!img || !counter || !photos.length) return;
      currentSlide = (currentSlide + photos.length) % photos.length;
      img.src = photos[currentSlide].src;
      counter.innerText = (currentSlide + 1) + " / " + photos.length;
      if (noteEl) noteEl.innerText = photos[currentSlide].note || "";
      if (dateEl) dateEl.innerText = albumMeta.date || "";
    }
    function nextSlide() {
      if (!photos.length) return;
      currentSlide = (currentSlide + 1) % photos.length;
      updateSlideImage();
    }
    function prevSlide() {
      if (!photos.length) return;
      currentSlide = (currentSlide - 1 + photos.length) % photos.length;
      updateSlideImage();
    }

    function applyAudioSettings() {
      const audio = document.getElementById("bgAudio");
      const opt = MUSIC_OPTIONS[albumMeta.music] || MUSIC_OPTIONS.none;
      if (!opt.src) {
        audio.pause();
        return;
      }
      if (audio.src !== opt.src) audio.src = opt.src;
    }
    function playAudioSafe() {
      const audio = document.getElementById("bgAudio");
      audio.play().catch(console.error);
    }

    function startAutoPlay() {
      if (isPlaying || !photos.length) return;
      isPlaying = true;
      slideTimer = setInterval(nextSlide, 3000);
      applyAudioSettings();
      if (albumMeta.music !== "none") playAudioSafe();
      updatePlayButton();
    }
    function stopAutoPlay() {
      if (slideTimer) clearInterval(slideTimer);
      slideTimer = null;
      const audio = document.getElementById("bgAudio");
      if (audio) audio.pause();
      isPlaying = false;
      updatePlayButton();
    }
    function togglePlay() {
      if (!photos.length) return;
      isPlaying ? stopAutoPlay() : startAutoPlay();
    }
    function updatePlayButton() {
      const btn = document.getElementById("playPauseBtn");
      if (!btn) return;
      btn.textContent = isPlaying ? "â¸ Durdur" : "â–¶ï¸ Oynat";
    }

    // Slayt swipe
    const overlayEl = document.getElementById("slideshow");
    if (overlayEl) {
      overlayEl.addEventListener("touchstart", e => {
        if (!e.changedTouches || !e.changedTouches.length) return;
        touchStartX = e.changedTouches[0].clientX;
      }, { passive:true });
      overlayEl.addEventListener("touchend", e => {
        if (!e.changedTouches || !e.changedTouches.length) return;
        touchEndX = e.changedTouches[0].clientX;
        const dx = touchEndX - touchStartX;
        if (Math.abs(dx) > 40) {
          if (dx < 0) nextSlide();
          else prevSlide();
        }
      }, { passive:true });
    }

    // Gezi durumu modalÄ±
    function openProgressModal() {
      const modal = document.getElementById("progressModal");
      const placesContainer = document.getElementById("progressPlaces");
      const foodsContainer  = document.getElementById("progressFoods");
      const purchaseContainer = document.getElementById("progressPurchase");
      const extrasContainer = document.getElementById("progressExtras");
      const resultEl = document.getElementById("progressResult");

      placesContainer.innerHTML = "";
      foodsContainer.innerHTML = "";
      purchaseContainer.innerHTML = "";
      extrasContainer.innerHTML = "";

      // Yerler
      Object.keys(PROGRESS_LABELS.places).forEach(key => {
        const row = document.createElement("label");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.gap = "6px";
        row.style.fontSize = "0.85rem";
        row.style.margin = "2px 0";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!progress.places[key];
        cb.onchange = () => {
          progress.places[key] = cb.checked;
          saveProgress();
        };

        const span = document.createElement("span");
        span.textContent = PROGRESS_LABELS.places[key];

        row.appendChild(cb);
        row.appendChild(span);
        placesContainer.appendChild(row);
      });

      // Yiyecekler
      Object.keys(PROGRESS_LABELS.foods).forEach(key => {
        const row = document.createElement("label");
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.gap = "6px";
        row.style.fontSize = "0.85rem";
        row.style.margin = "2px 0";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!progress.foods[key];
        cb.onchange = () => {
          progress.foods[key] = cb.checked;
          saveProgress();
        };

        const span = document.createElement("span");
        span.textContent = PROGRESS_LABELS.foods[key];

        row.appendChild(cb);
        row.appendChild(span);
        foodsContainer.appendChild(row);
      });

      // ÃœrÃ¼n satÄ±n alma
      const purchaseRow = document.createElement("label");
      purchaseRow.style.display = "flex";
      purchaseRow.style.alignItems = "center";
      purchaseRow.style.gap = "6px";
      purchaseRow.style.fontSize = "0.85rem";
      purchaseRow.style.margin = "2px 0";

      const purchaseCb = document.createElement("input");
      purchaseCb.type = "checkbox";
      purchaseCb.checked = !!progress.purchase;
      purchaseCb.onchange = () => {
        progress.purchase = purchaseCb.checked;
        saveProgress();
      };
      const purchaseSpan = document.createElement("span");
      purchaseSpan.textContent = "Bu ÅŸehirden (magnet hariÃ§) bir Ã¼rÃ¼n satÄ±n aldÄ±m";
      purchaseRow.appendChild(purchaseCb);
      purchaseRow.appendChild(purchaseSpan);
      purchaseContainer.appendChild(purchaseRow);

      // Ekstralar (3 kÃ¼Ã§Ã¼k metin)
      for (let i = 0; i < 3; i++) {
        const wrap = document.createElement("div");
        wrap.style.margin = "3px 0";

        const input = document.createElement("input");
        input.type = "text";
        input.style.width = "100%";
        input.style.padding = "4px 8px";
        input.style.borderRadius = "8px";
        input.style.border = "1px solid rgba(0,0,0,0.15)";
        input.style.fontSize = "16px";
        input.placeholder = "Ekstra anÄ± / etkinlik " + (i+1);
        input.value = progress.extras[i] || "";
        input.oninput = () => {
          progress.extras[i] = input.value;
          saveProgress();
        };

        wrap.appendChild(input);
        extrasContainer.appendChild(wrap);
      }

      if (progress.score != null) {
        const cityName = ALBUM_LABELS[CURRENT_ID] || "Bu ÅŸehir";
        resultEl.innerHTML = `${cityName} iÃ§in son hesaplanan skorun: %${progress.score}`;
      } else {
        resultEl.innerHTML = "";
      }

      modal.classList.add("active");
    }

    function closeProgressModal() {
      document.getElementById("progressModal").classList.remove("active");
    }

    function calculateProgress() {
      let done = 0;

      // 3 yer
      Object.keys(PROGRESS_LABELS.places).forEach(key => {
        if (progress.places[key]) done++;
      });
      // 3 yemek
      Object.keys(PROGRESS_LABELS.foods).forEach(key => {
        if (progress.foods[key]) done++;
      });
      // 1 Ã¼rÃ¼n satÄ±n alma
      if (progress.purchase) done++;
      // 3 ekstra metin
      let extraFilled = progress.extras.filter(t => t && t.trim().length > 0).length;
      if (extraFilled > 3) extraFilled = 3;
      done += extraFilled;

      // Toplam 10 etken â†’ her biri %10
      let percent = done * 10;
      if (percent > 100) percent = 100;

      progress.score = percent;
      saveProgress();
      updateTravelScoreDisplay();

      const cityName = ALBUM_LABELS[CURRENT_ID] || "Bu ÅŸehir";
      const resultEl = document.getElementById("progressResult");

      // DetaylÄ± metin (modal tekrar aÃ§Ä±ldÄ±ÄŸÄ±nda gÃ¶rÃ¼nsÃ¼n)
      let lines = [];
      lines.push(`${cityName} iÃ§in gezi skorun: %${percent}`);
      lines.push("<br><strong>GÃ¶rÃ¼lmesi gereken yerler:</strong>");
      Object.keys(PROGRESS_LABELS.places).forEach(key => {
        lines.push((progress.places[key] ? "âœ“ " : "âœ— ") + PROGRESS_LABELS.places[key]);
      });
      lines.push("<br><strong>Yenilmesi gereken lezzetler:</strong>");
      Object.keys(PROGRESS_LABELS.foods).forEach(key => {
        lines.push((progress.foods[key] ? "âœ“ " : "âœ— ") + PROGRESS_LABELS.foods[key]);
      });
      lines.push("<br><strong>ÃœrÃ¼n satÄ±n alma:</strong> " + (progress.purchase ? "âœ“ Evet" : "âœ— HayÄ±r"));
      if (extraFilled > 0) {
        lines.push("<br><strong>Ekstralar:</strong>");
        progress.extras.forEach((txt, i) => {
          if (txt && txt.trim().length > 0) {
            lines.push("- " + txt.trim());
          }
        });
      }
      resultEl.innerHTML = lines.join("<br>");

      // KullanÄ±cÄ±ya kÄ±sa mesaj
      if (percent >= 50) {
        alert(`Tebrikler! ${cityName} iÃ§in gezi skorun: %${percent}.`);
      } else {
        alert(`Bu sefer skorun biraz dÃ¼ÅŸÃ¼k kaldÄ±. ${cityName} iÃ§in gezi skorun: %${percent}.`);
      }

      closeProgressModal();
    }

    // BaÅŸlangÄ±Ã§
    render();
  </script>
</body>
</html>










